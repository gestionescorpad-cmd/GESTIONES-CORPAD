{% extends 'base.html' %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

<style>
    /* --- ESTÃ‰TICA JARVIS v12.3 (Data-First / Compact) --- */
    .neural-bg { background-color: #0f172a; }
    
    /* Status Dot */
    .system-status {
        width: 8px; height: 8px; background: #22c55e;
        border-radius: 50%; box-shadow: 0 0 8px #22c55e;
        transition: all 0.3s;
    }
    .system-status.processing { background: #eab308; box-shadow: 0 0 8px #eab308; animation: blink 0.5s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    /* Sugerencias IA */
    .sugerencia-ai { 
        cursor: pointer; transition: background 0.15s; 
        border-bottom: 2px dashed #a855f7; background: rgba(168, 85, 247, 0.05);
        border-radius: 2px; padding: 0 2px;
    }
    .sugerencia-ai:hover { 
        background: #a855f7; color: white !important; 
        box-shadow: 0 1px 4px rgba(168, 85, 247, 0.3); z-index: 10;
    }

    /* Context Colors */
    .ctx-dinero { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
    .ctx-fecha { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
    .ctx-legal { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); } 

    /* Chip Variable (Compacto) */
    .var-chip {
        display: inline-flex; align-items: center; gap: 4px;
        background: #f0fdf4; border: 1px solid #86efac;
        color: #15803d; font-weight: 700; font-family: 'Consolas', monospace;
        padding: 0px 4px; border-radius: 4px; font-size: 0.85em; 
        cursor: default; user-select: none; white-space: nowrap; vertical-align: baseline;
    }

    /* Chat Bubble (Compacto) */
    .chat-bubble {
        background: white; border-radius: 8px; padding: 8px 12px;
        margin-bottom: 8px; border-left: 3px solid #6366f1;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 11px;
        animation: fadeSlideUp 0.2s ease-out; word-wrap: break-word; line-height: 1.4;
    }
    @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .chat-actions { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
    .chat-btn {
        padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 10px;
        cursor: pointer; border: 1px solid #e2e8f0; background: #f8fafc; color: #475569;
        transition: all 0.2s;
    }
    .chat-btn.primary { background: #7c3aed; color: white; border-color: #7c3aed; }
    .chat-btn:hover { filter: brightness(0.95); }
    
    .btn-toolbar { 
        font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 4px;
        color: #64748b; transition: all 0.2s; padding: 4px 8px; border-radius: 4px;
    }
    .btn-toolbar:not(:disabled):hover { color: #7c3aed; background: #f1f5f9; }
    .btn-toolbar:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Custom Scrollbar Thin */
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

<div class="max-w-[1900px] mx-auto h-[calc(100vh-60px)] flex flex-col animate__animated animate__fadeIn p-2 font-sans text-slate-800">
    
    <div class="flex justify-between items-center mb-2 bg-white p-2 px-4 rounded-xl shadow-sm border border-gray-200">
        <div class="flex items-center gap-3">
            <div class="bg-slate-900 p-1.5 px-3 rounded-lg flex items-center gap-3 text-white shadow-md">
                <div id="sys-status-icon" class="system-status"></div>
                <div>
                    <span class="font-mono font-bold text-[10px] tracking-widest block text-cyan-400 leading-none">JARVIS</span>
                    <span id="sys-status-text" class="font-bold text-[9px] tracking-wide text-slate-300 leading-none">READY</span>
                </div>
            </div>
            <h2 class="text-sm font-black text-slate-700 uppercase tracking-tight">DiseÃ±ador Legal</h2>
        </div>

        <div class="flex gap-2">
            <input type="text" id="nombre-plantilla" placeholder="Nombre de la Plantilla..." class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-1 focus:ring-purple-500 outline-none block w-64 p-2 font-bold transition-all">
            <button id="btn-guardar" class="text-white bg-slate-900 hover:bg-black font-bold rounded-lg text-[10px] px-4 py-2 shadow-md flex items-center gap-2 transition-transform active:scale-95">
                <i class="fas fa-save"></i> GUARDAR
            </button>
        </div>
    </div>

    <div class="flex-1 flex gap-3 overflow-hidden">
        
        <div class="flex-1 bg-white rounded-2xl shadow-lg border border-gray-200 flex flex-col relative overflow-hidden group">
            
            <div id="drop-zone" class="absolute inset-0 bg-slate-50 z-30 flex flex-col items-center justify-center border-4 border-dashed border-purple-100 m-4 rounded-xl hover:bg-purple-50/50 transition-all cursor-pointer">
                <div class="w-20 h-20 bg-white rounded-full shadow-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-500">
                    <i class="fas fa-file-word text-4xl text-purple-600"></i>
                </div>
                <h3 class="text-xl font-black text-slate-700">Subir Contrato Base</h3>
                <p class="text-slate-400 text-xs mt-1">Arrastra tu archivo .docx</p>
                <input type="file" id="input-word-upload" accept=".docx" class="hidden">
            </div>

            <div id="editor-wrapper" class="relative flex-1 overflow-hidden hidden bg-[#f8fafc]">
                <div class="absolute top-4 left-0 right-0 flex justify-center z-20 pointer-events-none">
                    <div class="bg-white/95 backdrop-blur-sm border border-gray-200 shadow-lg rounded-full px-4 py-1.5 flex gap-4 items-center pointer-events-auto">
                        <button id="btn-re-escanear" class="btn-toolbar">
                            <i class="fas fa-sync-alt"></i> ESCANEAR
                        </button>
                        <div class="h-3 w-px bg-gray-300"></div>
                        <button id="btn-undo" class="btn-toolbar" disabled>
                            <i class="fas fa-undo"></i> DESHACER
                        </button>
                        <div class="h-3 w-px bg-gray-300"></div>
                        <span id="status-text" class="text-[9px] font-mono text-emerald-600 font-bold uppercase">IDLE</span>
                    </div>
                </div>

                <div id="editor-canvas" class="h-full overflow-y-auto p-16 custom-scrollbar text-justify prose max-w-none select-text bg-white shadow-xl mx-8 my-4 rounded-xl border border-gray-50 text-sm leading-relaxed">
                    </div>
            </div>
        </div>

        <div class="w-[450px] flex flex-col gap-3 h-full transition-all">
            
            <div class="h-[40%] bg-slate-50 rounded-2xl shadow-inner border border-gray-200 flex flex-col overflow-hidden relative">
                <div class="p-2 px-3 bg-white border-b border-gray-100 flex justify-between items-center shadow-sm z-10">
                    <span class="font-black text-[10px] text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-terminal text-purple-600"></i> Terminal
                    </span>
                    <button id="btn-limpiar-log" class="text-gray-300 hover:text-red-400 hover:bg-gray-50 p-1 rounded transition-colors"><i class="fas fa-eraser text-xs"></i></button>
                </div>
                <div id="chat-log" class="flex-1 overflow-y-auto p-3 custom-scrollbar flex flex-col-reverse relative bg-slate-50/50"></div>
            </div>

            <div class="h-[60%] bg-white rounded-2xl shadow-lg border border-purple-100 flex flex-col overflow-hidden relative">
                <div id="panel-header" class="p-3 bg-slate-900 text-white flex flex-col gap-1 transition-colors duration-300">
                    <div class="flex justify-between items-center">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">SELECCIÃ“N</span>
                        <span class="text-[9px] font-mono text-purple-300 opacity-50">CONTEXT_ID: NULL</span>
                    </div>
                    <div class="flex items-center gap-2 overflow-hidden bg-white/5 p-1.5 px-2 rounded-lg border border-white/10">
                        <i class="fas fa-quote-left text-purple-400 text-xs"></i>
                        <span id="texto-focus" class="text-xs font-bold truncate text-slate-200">Nada seleccionado...</span>
                    </div>
                </div>

                <div class="flex-1 flex flex-col overflow-hidden relative">
                    <div class="flex border-b border-gray-100">
                        <button id="tab-buscar" class="flex-1 py-2.5 text-[10px] font-black tracking-wide text-purple-700 border-b-2 border-purple-600 bg-purple-50/30 uppercase hover:bg-purple-50 transition-colors">VINCULAR</button>
                        <button id="tab-crear" class="flex-1 py-2.5 text-[10px] font-black tracking-wide text-gray-400 hover:bg-gray-50 uppercase transition-colors">CREAR</button>
                    </div>

                    <div id="mode-buscar" class="flex-1 flex flex-col p-3 gap-2 overflow-hidden">
                        <div class="relative group">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs group-focus-within:text-purple-500 transition-colors"></i>
                            <input type="text" id="filtro-existente" placeholder="Filtrar variables..." class="w-full pl-8 p-2 bg-gray-50 border border-gray-200 rounded-lg text-xs font-bold focus:ring-1 focus:ring-purple-200 outline-none transition-all">
                        </div>
                        <div id="lista-glosario" class="flex-1 overflow-y-auto custom-scrollbar space-y-1 pr-1">
                            {% for v in glosario %}
                            <div class="item-glosario p-2 px-3 rounded-lg border border-gray-100 hover:border-purple-200 hover:bg-purple-50 cursor-pointer flex justify-between items-center group transition-all" data-clave="{{ v.clave }}">
                                <div class="overflow-hidden">
                                    <p class="text-xs font-bold text-slate-700 group-hover:text-purple-800 truncate">{{ v.descripcion }}</p>
                                    <p class="text-[9px] text-slate-400 font-mono group-hover:text-purple-500 mt-0.5 truncate">{{ v.clave }}</p>
                                </div>
                                <div class="w-6 h-6 flex-shrink-0 rounded-full bg-white border border-gray-100 flex items-center justify-center group-hover:border-purple-200 group-hover:text-purple-600 transition-all shadow-sm">
                                    <i class="fas fa-link text-[10px] text-gray-300 group-hover:text-purple-600"></i>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div id="mode-crear" class="hidden flex-1 flex-col p-4 gap-3 overflow-y-auto bg-slate-50/50">
                        <div class="bg-white p-3 rounded-xl border border-purple-100 shadow-sm flex items-center gap-3">
                            <div class="w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
                                <i class="fas fa-magic text-xs"></i>
                            </div>
                            <div>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">IA</p>
                                <p class="text-[10px] font-bold text-purple-800">Autocompletado Activo</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase mb-1 block ml-1">CÃ³digo</label>
                            <div class="relative">
                                <input type="text" id="input-clave-nueva" class="w-full font-mono text-xs p-3 bg-white border border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-500/10 outline-none transition-all text-purple-700 font-bold placeholder-purple-200" placeholder="nombre_variable">
                                <div class="absolute right-3 top-3 text-purple-200 pointer-events-none"><i class="fas fa-code text-xs"></i></div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase mb-1 block ml-1">DescripciÃ³n</label>
                            <input type="text" id="input-desc-nueva" class="w-full text-xs p-3 bg-white border border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-500/10 outline-none transition-all placeholder-gray-300" placeholder="Ej: Nombre del cliente">
                        </div>

                        <button id="btn-crear-accion" class="mt-auto w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-black transition-all flex justify-center items-center gap-2 transform hover:-translate-y-0.5">
                            <i class="fas fa-plus-circle"></i> GUARDAR VARIABLE
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="form-final" method="POST" enctype="multipart/form-data" class="hidden">
    {% csrf_token %}
    <input type="text" name="nombre" id="input-nombre-final">
    <input type="file" name="archivo_base" id="input-archivo-final">
    <input type="hidden" name="reemplazos" id="input-reemplazos-final">
</form>

{% verbatim %}
<script>
/**
 * ðŸ§± JARVIS SECURITY LAYER
 */
const JarvisSecurity = {
    sanitizeHTML: (dirty) => DOMPurify.sanitize(dirty, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'u', 'p', 'br', 'table', 'tr', 'td', 'th', 'tbody', 'thead', 'ul', 'ol', 'li', 'span', 'div', 'h1', 'h2', 'h3'],
        ALLOWED_ATTR: ['class', 'style', 'colspan', 'rowspan'] 
    }),
    
    sanitizeString: (str) => {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
};

/**
 * ðŸ§  JARVIS HISTORY (Time Travel)
 */
const JarvisHistory = {
    undoStack: [],
    redoStack: [],

    pushAction(action) {
        this.undoStack.push(action);
        this.redoStack = []; 
        this.updateUI();
    },

    undo() {
        const action = this.undoStack.pop();
        if (!action) return;
        
        action.nodes.forEach(item => {
            JarvisDOM.restoreNode(item.current, item.originalText);
        });

        JarvisState.removeReplacement(action.variable, action.originalText);

        this.redoStack.push(action);
        this.updateUI();
        return action;
    },

    redo() {
        const action = this.redoStack.pop();
        if (!action) return;
        this.undoStack.push(action); 
        this.updateUI();
        return action;
    },

    updateUI() {
        document.getElementById('btn-undo').disabled = this.undoStack.length === 0;
    }
};

/**
 * ðŸ¢ JARVIS DOM
 */
const JarvisDOM = {
    replaceTextInNode: (textNode, matchText, replacementElement) => {
        if (textNode.nodeType !== Node.TEXT_NODE) return null;
        
        const fullText = textNode.nodeValue;
        const index = fullText.indexOf(matchText);
        if (index === -1) return null;

        const middleNode = textNode.splitText(index);
        middleNode.splitText(matchText.length);
        middleNode.parentNode.replaceChild(replacementElement, middleNode);
        
        return replacementElement;
    },

    restoreNode: (element, originalText) => {
        if (!element || !element.parentNode) return;
        const textNode = document.createTextNode(originalText);
        element.parentNode.replaceChild(textNode, element);
        textNode.parentNode.normalize(); 
    }
};

/**
 * ðŸ’¾ JARVIS STATE
 */
const JarvisState = {
    reemplazos: [], 
    archivo: null,
    selection: null,
    actionRegistry: new Map(), 

    addReplacement(texto, variable, modo) {
        this.reemplazos.push({ texto_original: texto, variable, modo });
    },

    removeReplacement(variable, texto) {
        const idx = this.reemplazos.findIndex(r => r.variable === variable && r.texto_original === texto);
        if (idx > -1) this.reemplazos.splice(idx, 1);
    },

    registerAction(id, callback) {
        this.actionRegistry.set(id, callback);
    },

    triggerAction(id) {
        if (this.actionRegistry.has(id)) {
            this.actionRegistry.get(id)();
            this.actionRegistry.delete(id); 
        }
    }
};

/**
 * ðŸ–¥ï¸ JARVIS UI
 */
const JarvisUI = {
    init() {
        this.bindEvents();
        this.log("Sistema Enterprise v12.3 Listo.", "system");
    },

    bindEvents() {
        const $ = (id) => document.getElementById(id);
        
        $('drop-zone').onclick = () => $('input-word-upload').click();
        $('input-word-upload').onchange = (e) => this.handleFileUpload(e.target.files[0]);
        $('editor-canvas').onmouseup = () => this.handleSelection();
        $('btn-re-escanear').onclick = () => this.runAnalysis();
        $('btn-undo').onclick = () => {
            const act = JarvisHistory.undo();
            if(act) this.log(`Deshacer: <b>${act.variable}</b> restaurado.`, 'robot');
        };
        $('btn-guardar').onclick = () => this.saveTemplate();
        $('btn-limpiar-log').onclick = () => $('chat-log').innerHTML = '';
        $('tab-buscar').onclick = () => this.setTab('buscar');
        $('tab-crear').onclick = () => this.setTab('crear');
        $('btn-crear-accion').onclick = () => this.apiCreateVariable();
        
        $('input-clave-nueva').oninput = (e) => {
            e.target.value = this.sanitizeVarName(e.target.value);
        };
        
        $('lista-glosario').addEventListener('click', (e) => {
            const item = e.target.closest('.item-glosario');
            if(item) this.promptAssignment(item.dataset.clave);
        });
        
        $('filtro-existente').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            document.querySelectorAll('.item-glosario').forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(val) ? 'flex' : 'none';
            });
        };
    },

    updateStatus(busy) {
        const icon = document.getElementById('sys-status-icon');
        const text = document.getElementById('sys-status-text');
        if(busy) {
            icon.classList.add('processing');
            text.innerText = "PROCESANDO";
            text.className = "font-bold text-[9px] tracking-wide text-yellow-400 leading-none";
        } else {
            icon.classList.remove('processing');
            text.innerText = "ESPERANDO";
            text.className = "font-bold text-[9px] tracking-wide text-emerald-400 leading-none";
        }
    },

    log(msg, type='robot', actions=[]) {
        const log = document.getElementById('chat-log');
        const div = document.createElement('div');
        div.className = `chat-bubble border-l-${type === 'user' ? 'pink' : 'indigo'}-500`;
        
        const safeMsg = JarvisSecurity.sanitizeString(msg);
        
        let actionsHtml = '';
        if (actions.length > 0) {
            actionsHtml = `<div class="chat-actions">` + 
                actions.map(a => {
                    JarvisState.registerAction(a.id, a.callback);
                    return `<button class="chat-btn ${a.primary?'primary':''}" onclick="JarvisState.triggerAction('${a.id}')">${a.label}</button>`;
                }).join('') +
                `</div>`;
        }

        div.innerHTML = `
            <div class="flex items-center gap-2 mb-1 opacity-70">
                <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i> 
                <span class="text-[9px] font-bold tracking-widest uppercase">${type === 'user' ? 'TÃº' : 'Jarvis'}</span>
            </div>
            <div class="text-slate-700 leading-relaxed font-medium text-xs">${safeMsg}</div>
            ${actionsHtml}
        `;
        log.prepend(div);
    },

    async handleFileUpload(file) {
        if (!file) return;
        JarvisState.archivo = file;
        this.updateStatus(true);
        
        const fd = new FormData();
        fd.append('archivo', file);
        
        const token = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const urlUpload = "/api/previsualizar-word/"; 

        try {
            const res = await fetch(urlUpload, { method: 'POST', body: fd, headers: {'X-CSRFToken': token} });
            const data = await res.json();
            
            if (data.html) {
                document.getElementById('editor-canvas').innerHTML = JarvisSecurity.sanitizeHTML(data.html);
                document.getElementById('drop-zone').classList.add('hidden');
                document.getElementById('editor-wrapper').classList.remove('hidden');
                this.runAnalysis();
            } else {
                throw new Error(data.msg);
            }
        } catch (e) {
            this.log(`Error: ${e.message}`, 'system');
        } finally {
            this.updateStatus(false);
        }
    },

    runAnalysis() {
        this.log("Escaneo heurÃ­stico iniciado...", "robot");
        const editor = document.getElementById('editor-canvas');
        
        editor.querySelectorAll('.sugerencia-ai').forEach(el => {
            const txt = document.createTextNode(el.innerText);
            el.parentNode.replaceChild(txt, el);
        });
        editor.normalize(); 

        const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
        const matchesToProcess = [];
        let node;

        const patterns = [
            { regex: new RegExp(/\b[A-Z&Ã‘]{3,4}\d{6}[A-Z0-9]{3}\b/, 'g'), css: 'ctx-legal', hint: 'RFC' },
            { regex: new RegExp(/\b\d{18}\b/, 'g'), css: 'ctx-dinero', hint: 'CLABE' },
            { regex: new RegExp(/\$\s?[\d,]+(\.\d{2})?/, 'g'), css: 'ctx-dinero', hint: 'Monto' },
            { regex: new RegExp(/\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/, 'g'), css: 'ctx-fecha', hint: 'Fecha' },
            { regex: new RegExp(/\b[\w\.-]+@[\w\.-]+\.\w{2,4}\b/, 'gi'), css: 'ctx-general', hint: 'Email' }
        ];

        while(node = walker.nextNode()) {
            if (node.parentNode.tagName !== 'P' && node.parentNode.tagName !== 'TD' && node.parentNode.tagName !== 'SPAN') continue; 
            if (node.parentNode.classList.contains('var-chip')) continue;

            const text = node.nodeValue;
            for (let p of patterns) {
                p.regex.lastIndex = 0; 
                const match = p.regex.exec(text); 
                if (match) {
                    matchesToProcess.push({ node, matchText: match[0], css: p.css });
                    break; 
                }
            }
        }

        let appliedCount = 0;
        matchesToProcess.forEach(item => {
            if (item.node.parentNode && item.node.nodeValue.includes(item.matchText)) {
                const span = document.createElement('span');
                span.className = `sugerencia-ai ${item.css}`;
                span.innerText = item.matchText;
                
                span.onclick = (e) => {
                    e.stopPropagation();
                    const range = document.createRange();
                    range.selectNodeContents(span);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                    this.handleSelection();
                };

                JarvisDOM.replaceTextInNode(item.node, item.matchText, span);
                appliedCount++;
            }
        });

        this.log(`AnÃ¡lisis: ${appliedCount} datos detectados.`, "robot");
    },

    handleSelection() {
        const sel = window.getSelection();
        const text = sel.toString().trim();
        if (!text) return;

        JarvisState.selection = { text, range: sel.getRangeAt(0).cloneRange() };
        
        document.getElementById('texto-focus').innerText = text.substring(0, 30) + (text.length>30?'...':'');
        document.getElementById('panel-header').classList.replace('bg-slate-900', 'bg-purple-900');

        const autoCode = "var_" + this.sanitizeVarName(text);
        document.getElementById('input-clave-nueva').value = autoCode.substring(0, 30);
        document.getElementById('input-desc-nueva').value = text;

        if (document.querySelectorAll('.item-glosario').length === 0) this.setTab('crear');
    },

    promptAssignment(variable) {
        if (!JarvisState.selection) return;
        const text = JarvisState.selection.text;
        
        const content = document.getElementById('editor-canvas').textContent;
        const escaped = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const count = (content.match(new RegExp(escaped, 'gi')) || []).length - 1;

        const actionId = crypto.randomUUID();

        if (count > 0) {
            this.log(`Texto "${text.substring(0,10)}..." se repite ${count} veces.`, 'robot', [
                { id: actionId+'_all', label: 'Vincular TODAS', primary: true, callback: () => this.executeAssignment(variable, true) },
                { id: actionId+'_one', label: 'Solo esta', primary: false, callback: () => this.executeAssignment(variable, false) }
            ]);
        } else {
            this.executeAssignment(variable, false);
        }
    },

    executeAssignment(variable, isMassive) {
        const { text, range } = JarvisState.selection;
        const nodesAffected = [];

        const createChip = () => {
            const s = document.createElement('span');
            s.className = 'var-chip animate__animated animate__bounceIn';
            s.innerText = `{{${variable}}}`;
            return s;
        };

        range.deleteContents();
        const mainChip = createChip();
        range.insertNode(mainChip);
        nodesAffected.push({ current: mainChip, originalText: text });

        if (isMassive) {
            const walker = document.createTreeWalker(document.getElementById('editor-canvas'), NodeFilter.SHOW_TEXT);
            const targets = [];
            let n;
            while(n = walker.nextNode()) {
                if (n.nodeValue.includes(text) && !n.parentNode.classList.contains('var-chip')) {
                    targets.push(n);
                }
            }

            targets.forEach(node => {
                while (node.nodeValue && node.nodeValue.includes(text)) {
                    const chip = createChip();
                    const nextNode = JarvisDOM.replaceTextInNode(node, text, chip);
                    if (nextNode) {
                        nodesAffected.push({ current: chip, originalText: text });
                        node = nextNode.nextSibling; 
                        if(!node || node.nodeType !== Node.TEXT_NODE) break;
                    } else { break; }
                }
            });
        }

        JarvisHistory.pushAction({
            variable,
            originalText: text,
            isMassive,
            nodes: nodesAffected 
        });

        JarvisState.addReplacement(text, variable, isMassive ? 'GLOBAL' : 'SINGLE');

        this.log(`Variable <b>${variable}</b> asignada.`, 'robot');
        this.clearSelection();
    },

    async apiCreateVariable() {
        const clave = document.getElementById('input-clave-nueva').value;
        const desc = document.getElementById('input-desc-nueva').value;
        if (!clave || !desc) return alert("Faltan datos");

        const btn = document.getElementById('btn-crear-accion');
        const txt = btn.innerText;
        btn.innerText = "PROCESANDO...";
        btn.disabled = true;

        const token = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const urlApi = "/api/crear-variable/";

        try {
            const res = await fetch(urlApi, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': token},
                body: JSON.stringify({ clave, descripcion: desc })
            });
            const data = await res.json();
            if(data.status === 'ok') {
                const varName = data.clave || clave;
                this.addGlossaryItem(varName, desc);
                this.promptAssignment(varName);
                this.setTab('buscar');
            } else {
                alert(data.msg);
            }
        } catch(e) { console.error(e); } 
        finally { btn.innerText = txt; btn.disabled = false; }
    },

    saveTemplate() {
        const nombre = document.getElementById('nombre-plantilla').value;
        if (!nombre || !JarvisState.archivo || JarvisState.reemplazos.length === 0) {
            return this.log("âŒ Faltan datos (Nombre, Archivo o Variables).", "robot");
        }
        document.getElementById('input-nombre-final').value = nombre;
        const dt = new DataTransfer(); dt.items.add(JarvisState.archivo);
        document.getElementById('input-archivo-final').files = dt.files;
        document.getElementById('input-reemplazos-final').value = JSON.stringify(JarvisState.reemplazos);
        
        this.log("Guardando...", "robot");
        document.getElementById('form-final').submit();
    },

    sanitizeVarName: (str) => {
        return str.trim().toLowerCase()
                  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                  .replace(/[^a-z0-9]/g, '_')
                  .replace(/_+/g, '_');
    },

    setTab(tab) {
        const buscar = document.getElementById('mode-buscar');
        const crear = document.getElementById('mode-crear');
        const tBuscar = document.getElementById('tab-buscar');
        const tCrear = document.getElementById('tab-crear');

        if(tab === 'buscar') {
            buscar.classList.remove('hidden'); crear.classList.add('hidden');
            tBuscar.className = "flex-1 py-2.5 text-[10px] font-black tracking-wide text-purple-700 border-b-2 border-purple-600 bg-purple-50/30 uppercase hover:bg-purple-50 transition-colors";
            tCrear.className = "flex-1 py-2.5 text-[10px] font-black tracking-wide text-gray-400 hover:bg-gray-50 uppercase transition-colors";
        } else {
            crear.classList.remove('hidden'); buscar.classList.add('hidden');
            tCrear.className = "flex-1 py-2.5 text-[10px] font-black tracking-wide text-purple-700 border-b-2 border-purple-600 bg-purple-50/30 uppercase hover:bg-purple-50 transition-colors";
            tBuscar.className = "flex-1 py-2.5 text-[10px] font-black tracking-wide text-gray-400 hover:bg-gray-50 uppercase transition-colors";
        }
    },

    addGlossaryItem(clave, desc) {
        const div = document.createElement('div');
        div.className = 'item-glosario p-2 px-3 rounded-lg border border-gray-100 hover:border-purple-200 hover:bg-purple-50 cursor-pointer flex justify-between items-center group transition-all animate__animated animate__fadeIn';
        div.dataset.clave = clave;
        div.innerHTML = `
            <div class="overflow-hidden">
                <p class="text-xs font-bold text-slate-700 group-hover:text-purple-800 truncate">${desc}</p>
                <p class="text-[10px] text-slate-400 font-mono group-hover:text-purple-500 mt-0.5 truncate">${clave}</p>
            </div>
            <div class="w-6 h-6 flex-shrink-0 rounded-full bg-white border border-gray-100 flex items-center justify-center group-hover:border-purple-200 group-hover:text-purple-600 transition-all shadow-sm">
                <i class="fas fa-link text-[10px] text-gray-300 group-hover:text-purple-600"></i>
            </div>`;
        document.getElementById('lista-glosario').prepend(div);
    },

    clearSelection() {
        window.getSelection().removeAllRanges();
        JarvisState.selection = null;
        document.getElementById('texto-focus').innerText = "Nada seleccionado";
        document.getElementById('panel-header').classList.replace('bg-purple-900', 'bg-slate-900');
    }
};

document.addEventListener('DOMContentLoaded', () => JarvisUI.init());
</script>
{% endverbatim %}
{% endblock %}