{% extends 'base.html' %}
{% block content %}
<div class="max-w-6xl mx-auto animate__animated animate__fadeIn">
    
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-black text-[#1A2238]">
            Gestionar Usuario: <span class="text-[#C0A062]">{{ u.username }}</span>
        </h2>
        <a href="{% url 'gestion_usuarios' %}" class="text-gray-500 font-bold hover:text-[#1A2238]">
            <i class="fas fa-arrow-left"></i> Volver a la lista
        </a>
    </div>

    <form method="POST" class="space-y-8">
        {% csrf_token %}

        {# ============================================== #}
        {# SECCI√ìN 1: PERFIL Y ROL                        #}
        {# ============================================== #}
        <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-[#1A2238] mb-4 border-b pb-2">
                <i class="fas fa-id-card mr-2"></i> Perfil y Rol
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div><label class="label-form">Nombre</label><input type="text" name="first_name" value="{{ u.first_name }}" class="input-form"></div>
                <div><label class="label-form">Apellidos</label><input type="text" name="last_name" value="{{ u.last_name }}" class="input-form"></div>
                <div><label class="label-form">Email</label><input type="email" name="email" value="{{ u.email }}" class="input-form"></div>
                <div><label class="label-form">Tel√©fono</label><input type="text" name="telefono" value="{{ u.telefono|default:'' }}" class="input-form"></div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                <label class="label-form text-blue-800 mb-2">Rol del Sistema</label>
                <select name="rol" id="rol_selector" class="w-full p-3 bg-white rounded-xl font-bold text-[#1A2238] border border-blue-200 outline-none" onchange="actualizarVistaPermisos()">
                    <option value="admin" {% if u.rol == 'admin' %}selected{% endif %}>üëë Administrador Master (Acceso Total)</option>
                    <option value="analista_sr" {% if u.rol == 'analista_sr' %}selected{% endif %}>üë®‚Äç‚öñÔ∏è Abogado Senior</option>
                    <option value="analista_jr" {% if u.rol == 'analista_jr' %}selected{% endif %}>üìù Abogado Junior / Pasante</option>
                </select>
                <p class="text-xs text-blue-600 mt-2">
                    * Si seleccionas "Administrador Master", el usuario tendr√° acceso a TODO autom√°ticamente.
                </p>
            </div>
        </div>

        {# ============================================== #}
        {# MENSAJE ADMIN (se muestra solo si rol=admin)   #}
        {# ============================================== #}
        <div id="mensaje-admin" class="hidden bg-green-50 border-l-4 border-green-500 p-6 rounded-r-xl shadow-sm my-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                    <i class="fas fa-shield-alt text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-green-800">Acceso Total Habilitado</h3>
                    <p class="text-sm text-green-700">Este usuario es Administrador. Tiene acceso a todas las herramientas, clientes y datos de contacto autom√°ticamente.</p>
                </div>
            </div>
        </div>

        {# ============================================== #}
        {# SECCI√ìN 2: PANEL DE PERMISOS (no-admin)        #}
        {# ============================================== #}
        <div id="panel-permisos" class="space-y-8 transition-all duration-300">
            
            {# --- 2A: M√ìDULOS DEL SISTEMA --- #}
            <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-[#C0A062] mb-2">
                    <i class="fas fa-cubes mr-2"></i> M√≥dulos del Sistema
                </h3>
                <p class="text-xs text-gray-400 mb-6">Controla a qu√© secciones principales puede acceder este usuario.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="access_cotizaciones" {% if u.access_cotizaciones %}checked{% endif %}>
                            <div>
                                <span class="check-title">üìÑ Cotizaciones y Cat√°logo</span>
                                <span class="check-desc">Crear, editar y enviar cotizaciones a prospectos. Gestionar el cat√°logo de servicios y precios.</span>
                            </div>
                        </div>
                    </label>

                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="access_finanzas" {% if u.access_finanzas %}checked{% endif %}>
                            <div>
                                <span class="check-title">üí∞ Finanzas y Cobranza</span>
                                <span class="check-desc">Ver panel financiero, cuentas por cobrar, registrar pagos y generar √≥rdenes de cobro y recibos.</span>
                            </div>
                        </div>
                    </label>

                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="access_agenda" {% if u.access_agenda %}checked{% endif %}>
                            <div>
                                <span class="check-title">üìÖ Agenda Legal</span>
                                <span class="check-desc">Acceder al calendario, crear eventos, audiencias y recordatorios. Mover eventos con drag & drop.</span>
                            </div>
                        </div>
                    </label>

                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="access_contratos" {% if u.access_contratos %}checked{% endif %}>
                            <div>
                                <span class="check-title">‚öñÔ∏è Generador de Contratos</span>
                                <span class="check-desc">Seleccionar plantillas, llenar variables y generar documentos DOCX personalizados por cliente.</span>
                            </div>
                        </div>
                    </label>

                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="access_disenador" {% if u.access_disenador %}checked{% endif %}>
                            <div>
                                <span class="check-title">üé® Dise√±ador de Plantillas</span>
                                <span class="check-desc">Subir documentos base, marcar textos y convertirlos en variables reutilizables para contratos.</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            {# --- 2B: PERMISOS SOBRE CLIENTES Y EXPEDIENTES --- #}
            <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-[#1A2238] mb-2">
                    <i class="fas fa-key mr-2"></i> Permisos sobre Clientes y Expedientes
                </h3>
                <p class="text-xs text-gray-400 mb-6">Define qu√© acciones puede realizar este usuario sobre los clientes y sus archivos.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="can_create_client" {% if u.can_create_client %}checked{% endif %}>
                            <div>
                                <span class="check-title">‚ûï Crear nuevos clientes</span>
                                <span class="check-desc">Dar de alta clientes desde el dashboard. Tambi√©n permite crear carpetas dentro de los expedientes.</span>
                            </div>
                        </div>
                    </label>

                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="can_edit_client" {% if u.can_edit_client %}checked{% endif %}>
                            <div>
                                <span class="check-title">‚úèÔ∏è Editar datos de clientes</span>
                                <span class="check-desc">Modificar nombre, contacto, tel√©fono, email y campos adicionales. Tambi√©n permite mover archivos entre carpetas y generar links de carga externa.</span>
                            </div>
                        </div>
                    </label>

                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="can_upload_files" {% if u.can_upload_files %}checked{% endif %}>
                            <div>
                                <span class="check-title">üì§ Subir archivos al Drive</span>
                                <span class="check-desc">Cargar documentos al expediente del cliente, incluyendo archivos con fecha de vencimiento y alertas autom√°ticas.</span>
                            </div>
                        </div>
                    </label>

                    <label class="check-card">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="can_view_documents" {% if u.can_view_documents %}checked{% endif %}>
                            <div>
                                <span class="check-title">üëÅÔ∏è Ver documentos</span>
                                <span class="check-desc">Visualizar archivos en el visor integrado (PDF, Word, Excel, im√°genes, video y audio).</span>
                            </div>
                        </div>
                    </label>
                </div>

                {# Permiso peligroso separado #}
                <div class="border-t border-gray-200 pt-4">
                    <p class="text-[10px] font-bold text-red-400 uppercase mb-3"><i class="fas fa-exclamation-triangle mr-1"></i> Zona de Riesgo</p>
                    <label class="check-card border-red-200 bg-red-50/50 hover:border-red-300">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" name="can_delete_client" {% if u.can_delete_client %}checked{% endif %}>
                            <div>
                                <span class="check-title text-red-600">üóëÔ∏è Eliminar clientes, carpetas y archivos</span>
                                <span class="check-desc">Permite borrar clientes completos, eliminar carpetas con todo su contenido, borrar archivos individuales y ejecutar eliminaciones masivas. <strong>Esta acci√≥n es irreversible.</strong></span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            {# --- 2C: INFORMACI√ìN VISIBLE --- #}
            <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-[#1A2238] mb-2">
                    <i class="fas fa-eye mr-2"></i> Informaci√≥n Visible
                </h3>
                <p class="text-xs text-gray-400 mb-4">Nota: Los datos de contacto del cliente (nombre del contacto, tel√©fono y email) <strong>solo son visibles para el Administrador</strong>. Los dem√°s usuarios √∫nicamente ver√°n el nombre de la empresa.</p>
                
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-lock text-amber-500 mt-1"></i>
                        <div class="text-xs text-amber-800">
                            <strong>Este usuario ver√°:</strong>
                            <ul class="mt-1 space-y-1 list-disc list-inside text-amber-700">
                                <li>Nombre de la empresa</li>
                                <li>Logo del cliente</li>
                                <li>Expediente y archivos (seg√∫n permisos de arriba)</li>
                            </ul>
                            <strong class="block mt-2">NO ver√°:</strong>
                            <ul class="mt-1 space-y-1 list-disc list-inside text-amber-700">
                                <li>Nombre del contacto</li>
                                <li>Tel√©fono del contacto</li>
                                <li>Email del contacto</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            {# --- 2D: CLIENTES ASIGNADOS --- #}
            <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-[#1A2238]"><i class="fas fa-briefcase mr-2"></i> Clientes Visibles</h3>
                        <p class="text-xs text-gray-400 mt-1">Solo podr√° ver los expedientes de los clientes marcados aqu√≠.</p>
                    </div>
                    <button type="button" onclick="seleccionarTodos()" class="text-xs font-bold text-[#C0A062] hover:underline">Seleccionar / Deseleccionar Todos</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 max-h-64 overflow-y-auto custom-scrollbar p-2 border border-gray-100 rounded-xl bg-gray-50">
                    {% for cliente in clientes %}
                    <label class="flex items-center gap-3 p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-all border border-transparent hover:border-[#C0A062]">
                        <input type="checkbox" name="clientes_asignados" value="{{ cliente.id }}" class="cliente-check w-5 h-5 text-[#1A2238] rounded" 
                            {% if cliente in u.clientes_asignados.all %}checked{% endif %}>
                        <div>
                            <span class="block text-xs font-bold text-[#1A2238]">{{ cliente.nombre_empresa }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

        </div> {# Fin panel-permisos #}

        {# ============================================== #}
        {# BOTONES DE ACCI√ìN                              #}
        {# ============================================== #}
        <div class="flex justify-between items-center pt-6 border-t border-gray-200">
            {% if request.user != u %}
            <button type="button" onclick="confirmarEliminacion()" class="text-red-500 font-bold text-xs hover:text-red-700 hover:underline px-4">
                <i class="fas fa-trash-alt mr-1"></i> Eliminar Usuario
            </button>
            {% else %}
            <div></div>
            {% endif %}

            <button type="submit" class="bg-[#1A2238] text-white px-10 py-4 rounded-xl font-black shadow-lg hover:bg-[#2C3E50] transition-all hover:-translate-y-1">
                GUARDAR CAMBIOS
            </button>
        </div>
    </form>
</div>

<style>
    .label-form { display: block; font-size: 0.75rem; font-weight: 700; color: #9CA3AF; text-transform: uppercase; margin-bottom: 0.5rem; }
    .input-form { width: 100%; padding: 0.75rem; background-color: #F9FAFB; border-radius: 0.75rem; font-weight: 700; color: #1F2937; border: 1px solid transparent; outline: none; }
    .input-form:focus { border-color: #C0A062; background-color: #fff; }

    /* Card-style checkboxes con descripci√≥n */
    .check-card {
        display: block;
        padding: 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #f3f4f6;
        background: #fafafa;
    }
    .check-card:hover {
        background-color: #F3F4F6;
        border-color: #e5e7eb;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .check-card:has(input:checked) {
        background-color: #f0fdf4;
        border-color: #bbf7d0;
    }
    .check-card input {
        width: 18px;
        height: 18px;
        accent-color: #C0A062;
        cursor: pointer;
        margin-top: 2px;
        flex-shrink: 0;
    }
    .check-title {
        display: block;
        font-weight: 700;
        font-size: 0.85rem;
        color: #374151;
        margin-bottom: 4px;
    }
    .check-desc {
        display: block;
        font-size: 0.7rem;
        color: #9CA3AF;
        line-height: 1.4;
    }
</style>

<script>
    function actualizarVistaPermisos() {
        const rol = document.getElementById('rol_selector').value;
        const panelPermisos = document.getElementById('panel-permisos');
        const mensajeAdmin = document.getElementById('mensaje-admin');

        if (rol === 'admin') {
            panelPermisos.classList.add('hidden');
            mensajeAdmin.classList.remove('hidden');
        } else {
            panelPermisos.classList.remove('hidden');
            mensajeAdmin.classList.add('hidden');
        }
    }

    function seleccionarTodos() {
        const checkboxes = document.querySelectorAll('.cliente-check');
        const estado = !checkboxes[0].checked;
        checkboxes.forEach(c => c.checked = estado);
    }

    function confirmarEliminacion() {
        if(confirm("¬øEST√ÅS SEGURO?\n\nEsta acci√≥n eliminar√° al usuario '{{ u.username }}' y todo su historial de acceso.\n\nNo se puede deshacer.")) {
            window.location.href = "{% url 'eliminar_usuario' u.id %}";
        }
    }

    document.addEventListener('DOMContentLoaded', actualizarVistaPermisos);
</script>
{% endblock %}